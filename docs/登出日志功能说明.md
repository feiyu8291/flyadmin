# 登录登出日志功能说明

## 功能概述

已完善登录和登出接口的日志记录功能，现在系统会自动记录用户的登录和登出操作，包括：
- 用户名
- 操作时间
- IP 地址
- **登录地点（根据 IP 地址自动解析）**
- 浏览器类型
- 操作系统
- 操作状态（成功/失败）
- 提示消息

## 实现细节

### 1. 新增工具类 `ServletUtil`

位置：`fly-common/src/main/java/com/fly/common/util/ServletUtil.java`

提供以下功能：
- `getClientIp()` - 获取客户端真实 IP 地址（支持代理）
- `getBrowser()` - 识别浏览器类型（Chrome、Firefox、Edge、Safari 等）
- `getOperatingSystem()` - 识别操作系统（Windows、Mac、Linux、Android、iOS 等）
- `getUserAgent()` - 获取完整的 User-Agent 字符串

### 2. 新增工具类 `IpUtil`

位置：`fly-common/src/main/java/com/fly/common/util/IpUtil.java`

**核心功能**：
- `getLocationByIp(String ip)` - 根据 IP 地址获取地理位置
  - 支持内网 IP 识别（返回 "内网IP"）
  - 支持本地 IP 识别（127.0.0.1、localhost、::1 等）
  - 使用 `mica-ip2region` 库进行 IP 地址解析
  - 返回格式：国家 省份 城市 运营商（例如："中国 广东省 深圳市 电信"）
- `getIpInfo(String ip)` - 获取详细的 IP 信息对象

**技术实现**：
- 使用 `mica-ip2region` 库（版本 2.7.18.9）
- 采用内存搜索模式，性能优秀
- 自动处理异常，解析失败返回 "未知"

### 3. 增强 `SysLoginLogService`

位置：`fly-business/src/main/java/com/fly/business/modules/monitor/service/SysLoginLogService.java`

新增方法：
- `recordLogin()` - 记录登录日志（支持成功和失败）
- `recordLogout()` - 记录登出日志

### 4. 完善 `AuthController` 登录和登出接口

位置：`fly-business/src/main/java/com/fly/business/modules/auth/controller/AuthController.java`

#### 登录接口 `/auth/login` 增强：
1. 从 HttpServletRequest 中提取客户端信息（IP、浏览器、操作系统）
2. 使用 `IpUtil` 根据 IP 地址获取地理位置
3. 在以下场景记录日志：
   - **用户不存在** - 记录失败日志，状态 "1"，消息 "用户不存在"
   - **密码错误** - 记录失败日志，状态 "1"，消息 "密码错误"
   - **用户已停用** - 记录失败日志，状态 "1"，消息 "用户已被停用"
   - **登录成功** - 记录成功日志，状态 "0"，消息 "登录成功"
   - **系统异常** - 记录失败日志，状态 "1"，消息包含异常信息
4. 日志记录失败不影响登录流程

#### 登出接口 `/auth/logout` 增强：
1. 从 Authorization header 中提取 JWT Token
2. 解析 Token 获取用户名
3. 从 HttpServletRequest 中提取客户端信息
4. 使用 `IpUtil` 根据 IP 地址获取地理位置
5. 调用 `loginLogService.recordLogout()` 记录日志
6. 即使日志记录失败也不影响登出操作

## 使用方式

### 前端调用示例

#### 登录请求
```javascript
// 登录请求
axios.post('/auth/login', {
  username: 'admin',
  password: 'admin123'
})
.then(response => {
  console.log('登录成功');
  // 保存 token
  localStorage.setItem('token', response.data.data.token);
  // 跳转到首页
  router.push('/home');
})
.catch(error => {
  console.error('登录失败', error);
});
```

#### 登出请求
```javascript
// 登出请求
axios.post('/auth/logout', {}, {
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
.then(response => {
  console.log('登出成功');
  // 清除本地 token
  localStorage.removeItem('token');
  // 跳转到登录页
  router.push('/login');
})
.catch(error => {
  console.error('登出失败', error);
});
```

### 数据库记录

登录和登出日志都保存在 `sys_login_log` 表中，字段说明：
- `info_id` - 自增主键
- `user_name` - 用户账号
- `ipaddr` - IP 地址
- `login_location` - 登录地点（**自动根据 IP 解析**，例如："中国 广东省 深圳市 电信"）
- `browser` - 浏览器类型
- `os` - 操作系统
- `use_status` - 状态（"0" 表示成功，"1" 表示失败）
- `msg` - 提示消息
  - 登录成功："登录成功"
  - 登录失败："用户不存在"、"密码错误"、"用户已被停用" 等
  - 登出成功："登出成功"
- `login_time` - 操作时间

### 查询日志示例

```sql
-- 查询最近的登出记录
SELECT * FROM sys_login_log 
WHERE msg = '登出成功' 
ORDER BY login_time DESC 
LIMIT 10;

-- 查询某个用户的登出记录
SELECT * FROM sys_login_log 
WHERE user_name = 'admin' AND msg = '登出成功'
ORDER BY login_time DESC;

-- 查询登录成功记录
SELECT * FROM sys_login_log 
WHERE use_status = '0' AND msg = '登录成功'
ORDER BY login_time DESC 
LIMIT 10;

-- 查询登录失败记录
SELECT * FROM sys_login_log 
WHERE use_status = '1'
ORDER BY login_time DESC 
LIMIT 10;

-- 查询某个用户的所有登录记录（包括成功和失败）
SELECT 
    user_name,
    ipaddr,
    login_location,
    browser,
    os,
    CASE use_status 
        WHEN '0' THEN '成功' 
        WHEN '1' THEN '失败' 
    END AS status,
    msg,
    login_time
FROM sys_login_log 
WHERE user_name = 'admin' AND msg LIKE '%登录%'
ORDER BY login_time DESC;

-- 统计某个 IP 的登录尝试次数
SELECT 
    ipaddr,
    login_location,
    COUNT(*) as attempt_count,
    SUM(CASE WHEN use_status = '0' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN use_status = '1' THEN 1 ELSE 0 END) as fail_count
FROM sys_login_log 
WHERE msg LIKE '%登录%'
GROUP BY ipaddr, login_location
ORDER BY attempt_count DESC;
```

## 后续优化建议

1. **异步日志记录**：对于高并发场景，可以考虑使用异步方式记录日志，避免影响接口响应速度
   - 可以使用 `@Async` 注解
   - 或者使用消息队列（如 RabbitMQ、Kafka）
2. **日志统计分析**：可以基于登录日志进行用户行为分析
   - 用户活跃时段统计
   - 常用设备和浏览器统计
   - 登录地点分布统计
   - 异常登录检测（如异地登录、频繁失败等）
3. **IP 地理位置数据更新**：定期更新 IP2Region 数据库，确保地理位置解析的准确性
4. **登录安全增强**：
   - 记录连续登录失败次数，超过阈值后锁定账户
   - 检测异常登录行为（如短时间内多次失败、异地登录等）
   - 支持登录验证码（在多次失败后要求输入验证码）

## 技术亮点

✅ **已完成的功能**：
1. ✅ IP 地址自动解析为地理位置（使用 mica-ip2region）
2. ✅ 完整的登录日志记录（成功和失败）
3. ✅ 完整的登出日志记录
4. ✅ 浏览器和操作系统自动识别
5. ✅ 内网 IP 和本地 IP 智能识别
6. ✅ 异常处理确保日志失败不影响业务

## 注意事项

- JWT Token 是可选的（`required = false`），即使没有 Token 也能记录登出操作
- 如果 Token 解析失败，用户名会记录为 "未知用户"
- 日志记录失败不会影响登录或登出操作的正常执行
- 所有异常都会被捕获并打印，确保接口稳定性
- IP 地址解析采用内存搜索模式，性能优秀，不会影响接口响应速度
- 对于内网 IP（192.168.x.x、10.x.x.x、172.16-31.x.x），会显示为 "内网IP"
- 对于本地 IP（127.0.0.1、localhost、::1），会显示为 "内网IP"
