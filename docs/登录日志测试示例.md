# IP 地址解析功能测试示例

## 测试场景

### 1. 本地 IP 测试
```java
// 测试本地 IP
String location1 = IpUtil.getLocationByIp("127.0.0.1");
// 预期结果：内网IP

String location2 = IpUtil.getLocationByIp("localhost");
// 预期结果：内网IP

String location3 = IpUtil.getLocationByIp("::1");
// 预期结果：内网IP
```

### 2. 内网 IP 测试
```java
// 测试内网 IP
String location1 = IpUtil.getLocationByIp("192.168.1.100");
// 预期结果：内网IP

String location2 = IpUtil.getLocationByIp("10.0.0.1");
// 预期结果：内网IP

String location3 = IpUtil.getLocationByIp("172.16.0.1");
// 预期结果：内网IP
```

### 3. 公网 IP 测试
```java
// 测试公网 IP（示例）
String location1 = IpUtil.getLocationByIp("114.114.114.114");
// 预期结果：中国 江苏省 南京市 电信（具体结果取决于 IP2Region 数据库）

String location2 = IpUtil.getLocationByIp("8.8.8.8");
// 预期结果：美国 加利福尼亚州 山景城 Google（具体结果取决于 IP2Region 数据库）
```

### 4. 无效 IP 测试
```java
// 测试无效 IP
String location1 = IpUtil.getLocationByIp(null);
// 预期结果：未知

String location2 = IpUtil.getLocationByIp("");
// 预期结果：未知

String location3 = IpUtil.getLocationByIp("unknown");
// 预期结果：未知
```

## 登录日志测试

### 测试步骤

1. **启动应用**
   ```bash
   cd d:\GitRepository\flyadmin\fly-business
   mvn spring-boot:run
   ```

2. **测试登录成功**
   ```bash
   curl -X POST http://localhost:8080/auth/login \
     -H "Content-Type: application/json" \
     -d "{\"username\":\"admin\",\"password\":\"admin123\"}"
   ```

3. **查看数据库日志**
   ```sql
   SELECT * FROM sys_login_log 
   ORDER BY login_time DESC 
   LIMIT 1;
   ```
   
   预期结果：
   - `user_name`: admin
   - `ipaddr`: 127.0.0.1 或实际 IP
   - `login_location`: 内网IP（如果是本地测试）
   - `browser`: 识别的浏览器类型
   - `os`: 识别的操作系统
   - `use_status`: 0（成功）
   - `msg`: 登录成功

4. **测试登录失败（用户不存在）**
   ```bash
   curl -X POST http://localhost:8080/auth/login \
     -H "Content-Type: application/json" \
     -d "{\"username\":\"nonexistent\",\"password\":\"123456\"}"
   ```

5. **查看数据库日志**
   ```sql
   SELECT * FROM sys_login_log 
   WHERE user_name = 'nonexistent'
   ORDER BY login_time DESC 
   LIMIT 1;
   ```
   
   预期结果：
   - `use_status`: 1（失败）
   - `msg`: 用户不存在

6. **测试登录失败（密码错误）**
   ```bash
   curl -X POST http://localhost:8080/auth/login \
     -H "Content-Type: application/json" \
     -d "{\"username\":\"admin\",\"password\":\"wrongpassword\"}"
   ```

7. **查看数据库日志**
   ```sql
   SELECT * FROM sys_login_log 
   WHERE user_name = 'admin' AND use_status = '1'
   ORDER BY login_time DESC 
   LIMIT 1;
   ```
   
   预期结果：
   - `use_status`: 1（失败）
   - `msg`: 密码错误

## 登出日志测试

### 测试步骤

1. **先登录获取 Token**
   ```bash
   curl -X POST http://localhost:8080/auth/login \
     -H "Content-Type: application/json" \
     -d "{\"username\":\"admin\",\"password\":\"admin123\"}"
   ```
   
   保存返回的 token

2. **测试登出**
   ```bash
   curl -X POST http://localhost:8080/auth/logout \
     -H "Authorization: Bearer YOUR_TOKEN_HERE"
   ```

3. **查看数据库日志**
   ```sql
   SELECT * FROM sys_login_log 
   WHERE msg = '登出成功'
   ORDER BY login_time DESC 
   LIMIT 1;
   ```
   
   预期结果：
   - `user_name`: admin
   - `ipaddr`: 127.0.0.1 或实际 IP
   - `login_location`: 内网IP（如果是本地测试）
   - `browser`: 识别的浏览器类型
   - `os`: 识别的操作系统
   - `use_status`: 0（成功）
   - `msg`: 登出成功

## 统计查询测试

### 1. 查询用户的登录成功率
```sql
SELECT 
    user_name,
    COUNT(*) as total_attempts,
    SUM(CASE WHEN use_status = '0' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN use_status = '1' THEN 1 ELSE 0 END) as fail_count,
    CONCAT(
        ROUND(SUM(CASE WHEN use_status = '0' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2),
        '%'
    ) as success_rate
FROM sys_login_log 
WHERE msg LIKE '%登录%'
GROUP BY user_name;
```

### 2. 查询最近 24 小时的登录活动
```sql
SELECT 
    user_name,
    ipaddr,
    login_location,
    browser,
    os,
    CASE use_status 
        WHEN '0' THEN '成功' 
        WHEN '1' THEN '失败' 
    END AS status,
    msg,
    login_time
FROM sys_login_log 
WHERE login_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY login_time DESC;
```

### 3. 查询异常登录（连续失败）
```sql
SELECT 
    user_name,
    ipaddr,
    login_location,
    COUNT(*) as fail_count,
    MAX(login_time) as last_fail_time
FROM sys_login_log 
WHERE use_status = '1' 
  AND login_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY user_name, ipaddr, login_location
HAVING fail_count >= 3
ORDER BY fail_count DESC;
```

## 性能测试

### IP 解析性能测试
```java
@Test
public void testIpUtilPerformance() {
    long startTime = System.currentTimeMillis();
    
    // 测试 1000 次 IP 解析
    for (int i = 0; i < 1000; i++) {
        String location = IpUtil.getLocationByIp("114.114.114.114");
    }
    
    long endTime = System.currentTimeMillis();
    long duration = endTime - startTime;
    
    System.out.println("1000 次 IP 解析耗时: " + duration + "ms");
    System.out.println("平均每次耗时: " + (duration / 1000.0) + "ms");
    
    // 预期：使用内存搜索模式，平均每次应该在 1ms 以内
}
```
